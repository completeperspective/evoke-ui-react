name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Remove PR preview directory
        run: |
          PR_DIR="pr-${{ github.event.number }}"
          
          if [ -d "$PR_DIR" ]; then
            echo "🗑️ Removing preview directory: $PR_DIR"
            rm -rf "$PR_DIR"
            
            # Configure git for the action
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            # Commit the removal
            git add -A
            git commit -m "🧹 Clean up PR #${{ github.event.number }} preview

            - Removed preview directory: $PR_DIR
            - PR was ${{ github.event.action }}: ${{ github.event.pull_request.title }}
            - Branch: ${{ github.event.pull_request.head.ref }}
            - Author: ${{ github.event.pull_request.user.login }}
            
            Auto-cleanup performed by GitHub Actions"
            
            git push origin gh-pages
            
            echo "✅ Successfully removed PR preview directory"
          else
            echo "ℹ️ No preview directory found for PR #${{ github.event.number }}"
          fi

      - name: Clean up artifacts
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // List all artifacts for this repository
              const artifacts = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              // Find and delete PR-specific artifacts
              const prArtifacts = artifacts.data.artifacts.filter(artifact => 
                artifact.name === `pr-preview-${{ github.event.number }}`
              );
              
              for (const artifact of prArtifacts) {
                console.log(`🗑️ Deleting artifact: ${artifact.name} (ID: ${artifact.id})`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              }
              
              if (prArtifacts.length > 0) {
                console.log(`✅ Cleaned up ${prArtifacts.length} artifact(s)`);
              } else {
                console.log(`ℹ️ No artifacts found for PR #${{ github.event.number }}`);
              }
            } catch (error) {
              console.log(`⚠️ Error cleaning up artifacts: ${error.message}`);
              // Don't fail the job if artifact cleanup fails
            }

      - name: Comment on PR about cleanup
        if: github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.number }};
            const wasMerged = ${{ github.event.pull_request.merged }};
            const action = wasMerged ? 'merged' : 'closed';
            const emoji = wasMerged ? '🎉' : '🗑️';
            
            const commentBody = `${emoji} **PR Preview Cleanup Complete**
            
            The Storybook preview for this PR has been automatically removed since the PR was ${action}.
            
            ### 📋 Cleanup Details
            - **Preview URL**: ~~https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.number }}/~~ (removed)
            - **Artifacts**: Temporary build artifacts cleaned up
            - **Action**: Automatic cleanup on PR ${action}
            
            ${wasMerged ? '🚀 **Changes are now live in the main documentation!**' : '💡 **No further action needed** - preview has been cleaned up.'}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody,
            });

      - name: Add job summary
        run: |
          ACTION_TYPE="${{ github.event.action }}"
          MERGED="${{ github.event.pull_request.merged }}"
          
          if [ "$MERGED" = "true" ]; then
            STATUS_EMOJI="🎉"
            STATUS_TEXT="merged"
          else
            STATUS_EMOJI="🗑️"
            STATUS_TEXT="closed"
          fi
          
          echo "## ${STATUS_EMOJI} PR Preview Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully cleaned up preview for PR that was **${STATUS_TEXT}**." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **PR #**: ${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.event.pull_request.head.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview Directory**: \`pr-${{ github.event.number }}/\` (removed)" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts**: Cleaned up successfully" >> $GITHUB_STEP_SUMMARY