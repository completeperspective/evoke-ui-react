name: Cleanup PR Preview

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    
    steps:
      - name: Clean up artifacts
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // List all artifacts for this repository
              const artifacts = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              // Find and delete PR-specific artifacts
              const prArtifacts = artifacts.data.artifacts.filter(artifact => 
                artifact.name === `pr-preview-${{ github.event.number }}`
              );
              
              for (const artifact of prArtifacts) {
                console.log(`ðŸ—‘ï¸ Deleting artifact: ${artifact.name} (ID: ${artifact.id})`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              }
              
              if (prArtifacts.length > 0) {
                console.log(`âœ… Cleaned up ${prArtifacts.length} artifact(s)`);
              } else {
                console.log(`â„¹ï¸ No artifacts found for PR #${{ github.event.number }}`);
              }
            } catch (error) {
              console.log(`âš ï¸ Error cleaning up artifacts: ${error.message}`);
              // Don't fail the job if artifact cleanup fails
            }

      - name: Comment on PR about cleanup
        if: github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.number }};
            const wasMerged = ${{ github.event.pull_request.merged }};
            const action = wasMerged ? 'merged' : 'closed';
            const emoji = wasMerged ? 'ðŸŽ‰' : 'ðŸ—‘ï¸';
            
            const commentBody = `${emoji} **PR Preview Cleanup Complete**
            
            The Storybook preview artifacts for this PR have been automatically cleaned up since the PR was ${action}.
            
            ### ðŸ“‹ Cleanup Details
            - **Artifacts**: \`pr-preview-${{ github.event.number }}\` (removed)
            - **Action**: Automatic cleanup on PR ${action}
            - **Status**: Build artifacts no longer available for download
            
            ${wasMerged ? 'ðŸš€ **Changes are now live in the main documentation!**' : 'ðŸ’¡ **No further action needed** - preview artifacts have been cleaned up.'}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody,
            });

      - name: Add job summary
        run: |
          ACTION_TYPE="${{ github.event.action }}"
          MERGED="${{ github.event.pull_request.merged }}"
          
          if [ "$MERGED" = "true" ]; then
            STATUS_EMOJI="ðŸŽ‰"
            STATUS_TEXT="merged"
          else
            STATUS_EMOJI="ðŸ—‘ï¸"
            STATUS_TEXT="closed"
          fi
          
          echo "## ${STATUS_EMOJI} PR Preview Cleanup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully cleaned up preview for PR that was **${STATUS_TEXT}**." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **PR #**: ${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.event.pull_request.head.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts**: \`pr-preview-${{ github.event.number }}\` (cleaned up)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Preview artifacts no longer available for download" >> $GITHUB_STEP_SUMMARY