name: Deploy PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Allow multiple PR preview deployments to run simultaneously
concurrency:
  group: 'pr-preview-${{ github.event.number }}'
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  pages: write
  id-token: write

jobs:
  # Build job for PR preview
  build-preview:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build component library
        working-directory: packages/evoke-ui-react
        run: |
          pnpm build
          pnpm type-check

      - name: Run tests
        working-directory: packages/evoke-ui-react
        run: pnpm run test -- --run

      - name: Build Storybook with PR branding
        working-directory: packages/evoke-ui-react
        run: |
          # Set PR-specific environment variables for branding
          export STORYBOOK_PR_NUMBER=${{ github.event.number }}
          export STORYBOOK_PR_TITLE="${{ github.event.pull_request.title }}"
          export STORYBOOK_PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          export STORYBOOK_PR_AUTHOR="${{ github.event.pull_request.user.login }}"

          # Build Storybook with PR-specific output directory
          pnpm build-storybook --output-dir ../../pr-preview-${{ github.event.number }}
        env:
          NODE_ENV: production

      - name: Create preview deployment metadata
        run: |
          mkdir -p pr-preview-${{ github.event.number }}
          cat > pr-preview-${{ github.event.number }}/pr-info.json << EOF
          {
            "pr_number": ${{ github.event.number }},
            "pr_title": "${{ github.event.pull_request.title }}",
            "pr_branch": "${{ github.event.pull_request.head.ref }}",
            "pr_author": "${{ github.event.pull_request.user.login }}",
            "commit_sha": "${{ github.event.pull_request.head.sha }}",
            "built_at": "$(date -u -Iseconds)",
            "preview_url": "https://github.com/${{ github.repository }}/pull/${{ github.event.number }}"
          }
          EOF

      - name: Upload PR preview artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-preview-${{ github.event.number }}
          path: ./pr-preview-${{ github.event.number }}
          retention-days: 30

  # Comment on PR with preview artifact link
  comment-preview:
    runs-on: ubuntu-latest
    needs: build-preview

    steps:
      - name: Download PR preview artifacts
        uses: actions/download-artifact@v4
        with:
          name: pr-preview-${{ github.event.number }}
          path: ./pr-preview-${{ github.event.number }}

      - name: Get artifact info
        id: get-artifact-info
        run: |
          # Generate a simple preview description
          ARTIFACT_NAME="pr-preview-${{ github.event.number }}"
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          
          # List files for verification
          echo "Preview contains:"
          ls -la ./pr-preview-${{ github.event.number }}/
          
          # Check if index.html exists
          if [ -f "./pr-preview-${{ github.event.number }}/index.html" ]; then
            echo "✅ Storybook build successful - index.html found"
          else
            echo "❌ Storybook build may have issues - index.html not found"
          fi

      - name: Comment PR with preview link
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.number }};
            const previewUrl = '${{ steps.get-preview-url.outputs.preview_url }}';
            const commitSha = '${{ github.event.pull_request.head.sha }}';
            const shortSha = commitSha.substring(0, 7);

            // Create comment body with preview information
            const artifactName = '${{ steps.get-artifact-info.outputs.artifact_name }}';
            const runId = '${{ github.run_id }}';
            const artifactUrl = `https://github.com/${{ github.repository }}/actions/runs/${runId}`;
            
            const commentBody = `## 🎨 Storybook Preview Built Successfully!

            Your component changes have been built and are ready for review:

            ### 📦 [**Download Preview Artifact**](${artifactUrl})

            The Storybook preview has been built as a downloadable artifact. You can:
            1. Click the link above to go to the workflow run
            2. Scroll down to "Artifacts" section  
            3. Download \`${artifactName}\` 
            4. Extract and open \`index.html\` in your browser

            ---

            ### 📊 Preview Details
            - **Branch**: \`${{ github.event.pull_request.head.ref }}\`
            - **Commit**: \`${shortSha}\`
            - **Built**: ${new Date().toISOString().split('T')[0]} at ${new Date().toTimeString().split(' ')[0]} UTC
            - **Artifact**: \`${artifactName}\`

            ### 🧪 What to Review
            - [ ] Component functionality and variants
            - [ ] Design token consistency  
            - [ ] Accessibility features
            - [ ] Documentation completeness
            - [ ] Visual regression testing

            ---

            > 💡 **Tip**: Download the artifact to test the Storybook locally. This approach ensures all builds work correctly before deployment.`;

            // Find existing preview comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const existingComment = comments.data.find(comment =>
              comment.body.includes('🎨 Storybook Preview Built Successfully!')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
            }

      - name: Add job summary
        run: |
          echo "## 🎨 PR Preview Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact**: pr-preview-${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Download**: [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 PR Information" >> $GITHUB_STEP_SUMMARY
          echo "- **PR #**: ${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Title**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.event.pull_request.head.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.event.pull_request.head.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📦 How to Review" >> $GITHUB_STEP_SUMMARY
          echo "1. Click the workflow run link above" >> $GITHUB_STEP_SUMMARY
          echo "2. Download the \`pr-preview-${{ github.event.number }}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "3. Extract the ZIP file and open \`index.html\` in your browser" >> $GITHUB_STEP_SUMMARY
